name: Update Gacha Meta

on:
    workflow_dispatch: {}
    schedule:
        - cron: '0 12 * * *'
    pull_request: {}

jobs:
    update:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v2

            - name: Set up Python
              uses: actions/setup-python@v2
              with:
                python-version: "3.10"

            - name: Install dependencies
              run: pip install -r Script/requirements.txt

            - name: Fetch latest commit SHA
              id: latest_sha
              run: echo "::set-output name=sha::$(git ls-remote https://github.com/Mar-7th/StarRailRes.git HEAD | cut -f1)"

            - name: Compare commit SHAs and run update script
              id: compare_shas
              run: |
                if [ "${{ steps.latest_sha.outputs.sha }}" != "${{ vars.RES_LATEST_UPDATE_COMMIT_SHA }}" ]; then
                  echo "Commit SHAs are different. Running the Python script..."
                  python Script/update_gacha_meta.py
                  echo "::set-output name=commit_sha_updated::true"
                else
                  echo "Commit SHAs are the same. No action needed."
                  echo "::set-output name=commit_sha_updated::false"
                fi

            - name: Configure Git
              if: steps.compare_shas.outputs.commit_sha_updated == 'true'
              run: |
                git config --global user.email "actions@github.com"
                git config --global user.name "GitHub Actions"

            - name: Create New Branch and Commit Changes
              if: steps.compare_shas.outputs.commit_sha_updated == 'true'
              run: |
                git checkout -b update-gacha-meta-${{ github.run_number }}
                git add .
                git commit -m "Update gacha meta"
                git push origin update-gacha-meta-${{ github.run_number }}

            - name: Create Pull Request
              if: steps.compare_shas.outputs.commit_sha_updated == 'true'
              uses: peter-evans/create-pull-request@v3
              with:
                token: ${{ secrets.GITHUB_TOKEN }}
                base: lava/gacha
                branch: update-gacha-meta-${{ github.run_number }}
                title: "Update Gacha Meta"
                body: |
                  This PR updates the gacha meta.
                labels: "auto-update"

            - name: Update SHA Variable
              if: steps.compare_shas.outputs.commit_sha_updated == 'true'
              run: echo "RES_LATEST_UPDATE_COMMIT_SHA=${{ steps.latest_sha.outputs.sha }}" >> $GITHUB_ENV